#!/bin/bash
#
# See if we have any results and download them
# uses a lock on the Study
# A new subroutine to update mydatabase......
update_cases()
{
  #We now make the new mycompleted_cases amd myincomplete_cases
  # using the new completed_this_run file (or left over from a
  # previous run_results which was killed for some reason).
  touch $sixdeskwork/completed_this_run

#MACRO mymktmp newccases $sixdeskwork
  sixdesktmpname=newccases
  sixdesktmpdirarg=$sixdeskwork
  sixdeskmktmp
  newccases=$sixdesktmp
#MACRO mymktmp


#MACRO mymktmp newicases $sixdeskwork
  sixdesktmpname=newicases
  sixdesktmpdirarg=$sixdeskwork
  sixdeskmktmp
  newicases=$sixdesktmp
#MACRO mymktmp

  touch $sixdeskwork/mycompleted_cases
  cat $sixdeskwork/mycompleted_cases $sixdeskwork/completed_this_run > $newccases
  sort --unique $newccases > $sixdeskwork/mycompleted_cases
  rm $newccases
  rm -f $sixdeskwork/sedscript.sed
  touch $sixdeskwork/sedscript.sed
  while read mycase
  do
  #make a sed script
    echo '/^'$mycase'$/d' >> $sixdeskwork/sedscript.sed
  done < $sixdeskwork/completed_this_run
  sed -f $sixdeskwork/sedscript.sed $sixdeskwork/myincomplete_cases > $newicases
  cp $newicases $sixdeskwork/myincomplete_cases
  rm -f $newicases
  rm -f $sixdeskwork/completed_this_run
  # and make another report

#MACRO mymess 1 Due to an AFS/Linux bug we maintain another database
  sixdeskmesslevel=1
  sixdeskmess="Due to an AFS/Linux bug we maintain another database"
  sixdeskmess
#MACRO mymess


#MACRO mymess 1 with the files myincomplete_cases and mycompleted_cases
  sixdeskmesslevel=1
  sixdeskmess="with the files myincomplete_cases and mycompleted_cases"
  sixdeskmess
#MACRO mymess


#MACRO mymess 1 to help find the problem
  sixdeskmesslevel=1
  sixdeskmess="to help find the problem"
  sixdeskmess
#MACRO mymess

  icases=0
  if test -s $sixdeskwork/myincomplete_cases
  then
    icases=`wc -l $sixdeskwork/myincomplete_cases`
    icases=`echo $icases | sed -e 's? *\([0-9]*\).*?\1?'`
  fi
  ccases=0
  if test -s $sixdeskwork/mycompleted_cases
  then
    ccases=`wc -l $sixdeskwork/mycompleted_cases`
    ccases=`echo $ccases | sed -e 's? *\([0-9]*\).*?\1?'`
  fi

#MACRO mymess 0 Before/after this download $cases mycases, $ccases complete ($icases incomplete)
  sixdeskmesslevel=0
  sixdeskmess="Before/after this download $cases mycases, $ccases complete ($icases incomplete)"
  sixdeskmess
#MACRO mymess

}

# ------------------------------------------------------------------------------
# preliminary to any action
# ------------------------------------------------------------------------------
# - get path to scripts (normalised)
if [ -z "${SCRIPTDIR}" ] ; then
    SCRIPTDIR=`dirname $0`
    SCRIPTDIR="`cd ${SCRIPTDIR};pwd`"
    export SCRIPTDIR=`dirname ${SCRIPTDIR}`
fi
# ------------------------------------------------------------------------------

#
# Even if called with a Study ($1) and a Platform ($2)
# we can now use dot_env
source ${SCRIPTDIR}/bash/dot_env
if test -s $sixdeskstudy/sixdesklock
then
  if test ! -w $sixdeskstudy/sixdesklock
  then
    echo "The Study $sixdeskstudy sixdesklock is ON; giving up!"
    echo "Script:Machine:Process `cat $sixdeskstudy/sixdesklock`"

#MACRO myexit 0
    sixdeskexitparam=0
    sixdeskexit
#MACRO myexit

  fi
fi
if test "$BNL" != ""
then

#MACRO mymess 0 You should use bnl_results to get results for this study!!!
  sixdeskmesslevel=0
  sixdeskmess="You should use bnl_results to get results for this study!!!"
  sixdeskmess
#MACRO mymess


#MACRO myexit 1
  sixdeskexitparam=1
  sixdeskexit
#MACRO myexit

fi

#MACRO mylock $sixdeskstudy
sixdesklockdir=$sixdeskstudy
sixdesklock
#MACRO mylock


#MACRO mymess 0 Starting in Workspace $workspace, Study `basename $sixdeskstudy`, Platform $sixdeskplatform
sixdeskmesslevel=0
sixdeskmess="Starting in Workspace $workspace, Study `basename $sixdeskstudy`, Platform $sixdeskplatform"
sixdeskmess
#MACRO mymess


#MACRO mymess 0 Using sixdesk.log in $sixdesklogdir
sixdeskmesslevel=0
sixdeskmess="Using sixdesk.log in $sixdesklogdir"
sixdeskmess
#MACRO mymess


if test $sixdeskplatform = "lsf"
then

#MACRO mymess 0 This command is not available for LSF jobs!!!
  sixdeskmesslevel=0
  sixdeskmess="This command is not available for LSF jobs!!!"
  sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
  sixdesklockdir=$sixdeskstudy
  sixdeskunlock
#MACRO myunlock


#MACRO myexit 1
  sixdeskexitparam=1
  sixdeskexit
#MACRO myexit

elif test $sixdeskplatform != "cpss" -a $sixdeskplatform != "boinc"
then
# GRID?

#MACRO mymess 0 Unknown platform! Did you mistype it?
  sixdeskmesslevel=0
  sixdeskmess="Unknown platform! Did you mistype it?"
  sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
  sixdesklockdir=$sixdeskstudy
  sixdeskunlock
#MACRO myunlock


#MACRO myexit 2
  sixdeskexitparam=2
  sixdeskexit
#MACRO myexit

fi
# Now update my database if a completed_this_run file exists froma previous run
if test -s $sixdeskwork/completed_this_run
then

#MACRO mylock $sixdeskwork
  ###sixdesklockdir=$sixdeskwork
  ###sixdesklock
#MACRO mylock

  update_cases

#MACRO myunlock $sixdeskwork
  ###sixdesklockdir=$sixdeskwork
  ###sixdeskunlock
#MACRO myunlock

fi
# Get the counts before we run for checking later

#MACRO mylock $sixdeskwork
###sixdesklockdir=$sixdeskwork
###sixdesklock
#MACRO mylock

if test -f $sixdeskwork/taskids
then
  cases=`wc -l "$sixdeskwork/taskids"`
  cases=`echo "$cases" | sed -e 's? *\([0-9]*\).*?\1?'`
fi
icases=0
if test -s $sixdeskwork/incomplete_cases
then
  icases=`wc -l $sixdeskwork/incomplete_cases`
  icases=`echo $icases | sed -e 's? *\([0-9]*\).*?\1?'`
fi
ccases=0
if test -s $sixdeskwork/completed_cases
then
  ccases=`wc -l $sixdeskwork/completed_cases`
  ccases=`echo $ccases | sed -e 's? *\([0-9]*\).*?\1?'`
fi

#MACRO myunlock $sixdeskwork
###sixdesklockdir=$sixdeskwork
###sixdeskunlock
#MACRO myunlock



#MACRO mymess 0 Running on `hostname`
sixdeskmesslevel=0
sixdeskmess="Running on `hostname`"
sixdeskmess
#MACRO mymess

IDS=$sixdeskwork
mkdir -p $sixdeskjobs

#MACRO mymktmp tmp $sixdeskjobs
sixdesktmpname=tmp
sixdesktmpdirarg=$sixdeskjobs
sixdeskmktmp
tmp=$sixdesktmp
#MACRO mymktmp


#MACRO mymktmp sixdesktasklist $sixdeskjobs
sixdesktmpname=sixdesktasklist
sixdesktmpdirarg=$sixdeskjobs
sixdeskmktmp
sixdesktasklist=$sixdesktmp
#MACRO mymktmp

if test $sixdeskplatform = "cpss"
then
  if test ! -s $sixdeskstudy/TaskGroupId
  then
    rm $tmp
    rm $sixdesktasklist

#MACRO mymess 0 No TaskGroup exists for CPSS.
    sixdeskmesslevel=0
    sixdeskmess="No TaskGroup exists for CPSS."
    sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
    sixdesklockdir=$sixdeskstudy
    sixdeskunlock
#MACRO myunlock


#MACRO myexit 0
    sixdeskexitparam=0
    sixdeskexit
#MACRO myexit

  fi
  tgid=`cat $sixdeskstudy/TaskGroupId`
  mytgid=`echo $tgid | sed -e 's/TaskGroupID: *//'`

#MACRO mymess 0 Checking TaskGroup $mytgid for $LHCDescrip
  sixdeskmesslevel=0
  sixdeskmess="Checking TaskGroup $mytgid for $LHCDescrip"
  sixdeskmess
#MACRO mymess

  perl ${SCRIPTDIR}/perl/queryReadyResults.pl $mytgid > $tmp
  stat=$?
  if test $stat -ne 0
  then

#MACRO mymess 0 Problem with query ReadyResults Status $stat `cat $tmp`
    sixdeskmesslevel=0
    sixdeskmess="Problem with query ReadyResults Status $stat `cat $tmp`"
    sixdeskmess
#MACRO mymess

    rm $tmp
    rm $sixdesktasklist

#MACRO myunlock $sixdeskstudy
    sixdesklockdir=$sixdeskstudy
    sixdeskunlock
#MACRO myunlock


#MACRO myexit 99
    sixdeskexitparam=99
    sixdeskexit
#MACRO myexit

  fi
  # remove the \r's............

#MACRO mymktmp sixdeskresults $sixdeskjobs
  sixdesktmpname=sixdeskresults
  sixdesktmpdirarg=$sixdeskjobs
  sixdeskmktmp
  sixdeskresults=$sixdesktmp
#MACRO mymktmp

  awk -f ${SCRIPTDIR}/awk/remover.awk $tmp > $sixdeskresults
  rm $tmp
  tot=`grep TotalTasks $sixdeskresults | sed -e 's/TotalTasks: *//'`
  ready=`grep ResultsReady $sixdeskresults | sed -e 's/ResultsReady: *//'`

#MACRO mymess 1 Out of $tot Tasks $ready Results are available
  sixdeskmesslevel=1
  sixdeskmess="Out of $tot Tasks $ready Results are available"
  sixdeskmess
#MACRO mymess

  cat $sixdeskresults
  tasks=`grep ReadyTasks $sixdeskresults | sed -e 's/ReadyTasks: *//'`
  rm $sixdeskresults

#MACRO mymktmp sixdesktasks $sixdeskjobs
  sixdesktmpname=sixdesktasks
  sixdesktmpdirarg=$sixdeskjobs
  sixdeskmktmp
  sixdesktasks=$sixdesktmp
#MACRO mymktmp

  echo "$tasks" > $sixdesktasks
  awk -f ${SCRIPTDIR}/awk/splitter.awk $sixdesktasks > $sixdesktasklist
  rm $sixdesktasks 
elif test $sixdeskplatform = "boinc"
then
  sixdeskboinc=$sixdeskboincdir
  export sixdeskboinc

  if test ! -d $sixdeskboincdir
  then
    mkdir -p $sixdeskboincdir
    # and here use AFS protection group stuff to fix access control list
    fs setacl $sixdeskboincdir $LOGNAME rlidwka $sixdeskpts rl
  fi
  if test -s $sixdeskboincdir/owner
  then
    sixdeskowner=`cat $sixdeskboincdir/owner`
    if test "$sixdeskowner" != "$LOGNAME"
    then

#MACRO mymess 0 The workspace/LHCDescrip $sixdeskboincdirname are already in use by $sixdeskowner!!!
      sixdeskmesslevel=0
      sixdeskmess="The workspace/LHCDescrip $sixdeskboincdirname are already in use by $sixdeskowner!!!"
      sixdeskmess
#MACRO mymess

      rm -f $tmp
      rm -f $sixdesktasklist

#MACRO myunlock $sixdeskstudy
      sixdesklockdir=$sixdeskstudy
      sixdeskunlock
#MACRO myunlock


#MACRO myexit 11
      sixdeskexitparam=11
      sixdeskexit
#MACRO myexit

    fi
  else
    echo "$LOGNAME" > $sixdeskboincdir/owner
  fi
  if test ! -d $sixdeskboincdir/work
  then
    mkdir -p $sixdeskboincdir/work
  fi
  if test ! -d $sixdeskboincdir/results
  then
    mkdir -p $sixdeskboincdir/results
  fi
  cd $sixdeskboinc/results
  find . -name ${workspace}_${LHCDesName}__\*_1_sixvf_boinc\* > $tmp 2> /dev/null
  cd $sixdeskhome

#MACRO mymktmp sixdeskresults $sixdeskjobs
  sixdesktmpname=sixdeskresults
  sixdesktmpdirarg=$sixdeskjobs
  sixdeskmktmp
  sixdeskresults=$sixdesktmp
#MACRO mymktmp

  sed -f ${SCRIPTDIR}/sed/boincnames.sed $tmp > $sixdeskresults
  rm $tmp
  ready=`wc -l $sixdeskresults`
  ready=`echo $ready | sed -e 's? *\([0-9]*\).*?\1?'`

#MACRO mymess 0 $ready Results are available
# sixdeskmesslevel=0
# sixdeskmess="$ready Results are available"
# sixdeskmess
#MACRO mymess

  cat $sixdeskresults

#MACRO mymess 0 $ready Results are available
  sixdeskmesslevel=0
  sixdeskmess="$ready Results are available"
  sixdeskmess
#MACRO mymess

  cut -d"%" -f6- $sixdeskresults > $tmp 
  cut -d"_" -f4 $tmp > $sixdesktasklist
  rm $tmp
  rm $sixdeskresults
elif test "$sixdeskplatform" = "grid"
then
  # Here will produce a sixdesktasklist for GRID
  echo "GRID not yet implemented"
  rm -f $tmp
  rm -f $sixdesktasklist

#MACRO myunlock $sixdeskstudy
  sixdesklockdir=$sixdeskstudy
  sixdeskunlock
#MACRO myunlock


#MACRO myexit 89
  sixdeskexitparam=89
  sixdeskexit
#MACRO myexit

fi
ok=0
duplicated=0
failed=0

rm -f $sixdeskwork/completed_this_run

touch $sixdesktasklist
for ntaskid in `cat $sixdesktasklist`
do
  if test $sixdeskplatform = "cpss"
  then
    taskid=cpss$ntaskid
  else
    taskid=$ntaskid
  fi
  success="false"
  ignore="true"
  delete="false"
  duplicate="false"
  anerror="false"
  unknown="false"

#MACRO mymess 1 Now treating TaskID $taskid
  sixdeskmesslevel=1
  sixdeskmess="Now treating TaskID $taskid"
  sixdeskmess
#MACRO mymess

  Runnam=""
  Rundir=""
  where=""
  taskids=""
  entry=`grep " $taskid " $IDS/taskids`
  if test "$entry" != ""
  then
    Runnam=`echo $entry | cut -d" " -f1`
    if test $sixdeskplatform = "boinc"
    then
      aboincRunnam=`echo $Runnam | sed -e's/%/__/g'`
      if test ! -f $sixdeskboincdir/results/$workspace"_"$aboincRunnam"_1_sixvf_"$taskid
      then
      # Hopefully because of duplicate TaskIds

#MACRO mymess 1 Looking for duplicates TaskId $taskid
        sixdeskmesslevel=1
        sixdeskmess="Looking for duplicates TaskId $taskid"
        sixdeskmess
#MACRO mymess


#MACRO mymktmp boincdup $sixdeskjobs
        sixdesktmpname=boincdup
        sixdesktmpdirarg=$sixdeskjobs
        sixdeskmktmp
        boincdup=$sixdesktmp
#MACRO mymktmp

        grep " $taskid " $IDS/taskids > $boincdup
        mytimes=`wc -l $boincdup`
        mytimes=`echo "$mytimes" | sed -e 's? *\([0-9]*\).*?\1?'`
        if test "$mytimes" -gt 1
        then

#MACRO mymess 0 FOUND duplicate TaskId  $taskid Times $mytimes
          sixdeskmesslevel=0
          sixdeskmess="FOUND duplicate TaskId  $taskid Times $mytimes"
          sixdeskmess
#MACRO mymess

          while read myline
          do
            aRunnam=`echo $myline | cut -d" " -f1`
            aboincRunnam=`echo $aRunnam | sed -e's/%/__/g'`
            if test -f $sixdeskboincdir/results/$workspace"_"$aboincRunnam"_1_sixvf_"$taskid
            then
              #found one, may be more!

#MACRO mymess 0 Found the duplicated entry $taskid $aRunnam
              sixdeskmesslevel=0
              sixdeskmess="Found the duplicated entry $taskid $aRunnam"
              sixdeskmess
#MACRO mymess

              entry=$myline
              Runnam=`echo $entry | cut -d" " -f1` 

#MACRO mymess 0 Using $Runnam for $taskid
              sixdeskmesslevel=0
              sixdeskmess="Using $Runnam for $taskid"
              sixdeskmess
#MACRO mymess

              break
            fi
          done < $boincdup
        else

#MACRO mymess 0 A very serious problem in matching TaskID/Runnam!!!
          sixdeskmesslevel=0
          sixdeskmess="A very serious problem in matching TaskID/Runnam!!!"
          sixdeskmess
#MACRO mymess


#MACRO mymess 0 Could not resolve TaskId $taskid
          sixdeskmesslevel=0
          sixdeskmess="Could not resolve TaskId $taskid"
          sixdeskmess
#MACRO mymess

        fi
        rm -f $boincdup
      fi
    fi
    taskids=`echo $entry | cut -d" " -f2-`

#MACRO myrundir $Runnam Rundir
    runnamename=$Runnam
    sixdeskrundir
    Rundir=$rundirname
#MACRO myrundir

    where=$sixdesktrack/$Rundir

#MACRO mymess 1 Task $taskid for job $Runnam found in $Rundir
    sixdeskmesslevel=1
    sixdeskmess="Task $taskid for job $Runnam found in $Rundir"
    sixdeskmess
#MACRO mymess

  fi
  if test "$Runnam" = ""
  then 

#MACRO mymess 0 Task $taskid can NOT be found in $sixdeskwork/taskids !!! Deleting result from the server
    sixdeskmesslevel=0
    sixdeskmess="Task $taskid can NOT be found in $sixdeskwork/taskids !!! Deleting result from the server"
    sixdeskmess
#MACRO mymess

    delete="true"
    anerror="true"
    unknown="true"
  else
    where=$sixdesktrack/$Rundir
    if test ! -d "$where"
    then

#MACRO mymess 0 Strange the directory $where for task $taskid does NOT exist!!! We shall ignore this result for the moment
      sixdeskmesslevel=0
      sixdeskmess="Strange the directory $where for task $taskid does NOT exist!!! We shall ignore this result for the moment"
      sixdeskmess
#MACRO mymess

      delete="true"
      anerror="true"
    else
      #let us get the results downloaded
      #sixres.tar.gz will be put here
      cd $where
      if test $sixdeskplatform = "cpss"
      then
        perl ${SCRIPTDIR}/perl/downloadResult.pl $mytgid $ntaskid > down 2>&1
        stat=$?
      elif test $sixdeskplatform = "boinc"
      then
        found="false"
        boincRunnam=`echo $Runnam | sed -e's/%/__/g'`
        if test ! -f $sixdeskboincdir/results/$workspace"_"$boincRunnam"_1_sixvf_"$taskid
        then

#MACRO mymess 0 CANNOT FIND the result file!!!
          sixdeskmesslevel=0
          sixdeskmess="CANNOT FIND the result file!!!"
          sixdeskmess
#MACRO mymess

          anerror="true"
        else
          echo "Found in hierarchy $sixdeskboincdir"
          found="true"
        fi
        if test "$found" = "true"
        then
          mkdir -p sixtrack
          awk -f ${SCRIPTDIR}/awk/remover.awk $sixdeskboincdir/results/$workspace"_"$boincRunnam"_1_sixvf_"$taskid > sixtrack/fort.10
          cd sixtrack
          if test -s ../fort.10.gz
          then
            cp ../fort.10.gz old.10.gz
            gunzip -f old.10.gz
#           diff old.10 fort.10 > /dev/null 2>&1
# Cannot diff anymore because of version number

#MACRO mymktmpdir diffs 
            sixdesktmpdirname=diffs
            sixdesktmpdirarg=
            sixdeskmktmpdir
            diffs=$sixdesktmpdir
#MACRO mymktmp

            cp old.10 $diffs/fort.20
            cp fort.10 $diffs/fort.21
            cd $diffs
            ${SCRIPTDIR}/fortran/verify10.exe | grep DIFF > diffs
            stat=$?
            cd ..
            if test $stat -ne 0
            then
              rm -r $diffs

#MACRO mymess 1 Results in fort.10 identical to previous run. Ignore and remove it
              sixdeskmesslevel=1
              sixdeskmess="Results in fort.10 identical to previous run. Ignore and remove it"
              sixdeskmess
#MACRO mymess

              ignore="true"
              delete="true"
              duplicate="true"
  # This line added to ensure that the case is marked completed
  # The results may have been produced by a different workspace
              success="true"
            else

#MACRO mymess 0 New fort.10 from Task $taskid is different!!!!
              sixdeskmesslevel=0
              sixdeskmess="New fort.10 from Task $taskid is different!!!!"
              sixdeskmess
#MACRO mymess

              while read aline
              do

#MACRO mymess 0 Verify10: $aline
                sixdeskmesslevel=0
                sixdeskmess="Verify10: $aline"
                sixdeskmess
#MACRO mymess

              done < $diffs/diffs
              rm -r $diffs
              words=`wc -w fort.10`
              words=`echo $words | sed -e 's? *\([0-9]*\).*?\1?'`
              lines=`wc -l fort.10`
              lines=`echo $lines | sed -e 's? *\([0-9]*\).*?\1?'`
              nwords=`expr $sixdeskpairs \* 60`
              if test "$words" -ne  $nwords -o "$lines" -ne $sixdeskpairs
              then

#MACRO mymess 0 We have $words words, $lines lines in NEW fort.10 (NOT $nwords, $sixdeskpairs)
                sixdeskmesslevel=0
                sixdeskmess="We have $words words, $lines lines in NEW fort.10 (NOT $nwords, $sixdeskpairs)"
                sixdeskmess
#MACRO mymess


#MACRO mymess 0 THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!
                sixdeskmesslevel=0
                sixdeskmess="THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!"
                sixdeskmess
#MACRO mymess

                mkdir -p ../problems
                cp fort.10 ../problems/problem$taskid
                ignore="true"
                delete="true"
                anerror="true"
              else
                ln -sf old.10 fort.20
                ln -sf fort.10 fort.21
#               ${SCRIPTDIR}/bash/checktens > $tmp
                ${SCRIPTDIR}/fortran/verify10.exe > $tmp
                vermess=`grep "VERSION" $tmp`

#MACRO mymess 1 fort.10 check $vermess
                sixdeskmesslevel=1
                sixdeskmess="fort.10 check $vermess"
                sixdeskmess
#MACRO mymess

                numdiffs=`grep "DIFF fort.10, line" $tmp | wc -l`
                numdiffs=`echo "$numdiffs" | sed -e 's? *\([0-9]*\).*?\1?'`
                numok=`egrep "SAME 22|SAME 23" $tmp | wc -l`
                numok=`echo "$numok" | sed -e 's? *\([0-9]*\).*?\1?'`
                numok=`expr "$numok" / 2`
                particles=`expr $sixdeskpairs \* 2`
                if test "$numok" -ne "$numdiffs" -a "$numdiffs" -ne 0
                then

#MACRO mymess 0 Lost turn numbers different THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!
                  sixdeskmesslevel=0
                  sixdeskmess="Lost turn numbers different THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!"
                  sixdeskmess
#MACRO mymess

                  ignore="true"
# For BOINC for the time being just ignore it and delete it.
                  delete="true"
                  anerror="true"
                  mkdir -p ../problems
                  cp fort.10 ../problems/problem$taskid
                  cp $tmp ../problems/diffs$taskid
                else
                  grep "DIFF" $tmp >/dev/null 2>&1
                  if test $? -ne 0
                  then

#MACRO mymess 0 exponent e? NO numerical difference !!!
                    sixdeskmesslevel=0
                    sixdeskmess="exponent e? NO numerical difference !!!"
                    sixdeskmess
#MACRO mymess

                  else

#MACRO mymess 0 This is ACCEPTABLE as different but lost turns are the same
                    sixdeskmesslevel=0
                    sixdeskmess="This is ACCEPTABLE as different but lost turns are the same"
                    sixdeskmess
#MACRO mymess

                  fi
                  ignore="true"
                  delete="true"
                  duplicate="true"
                  mkdir -p ../problems
                  cp fort.10 ../problems/problem$taskid
                  cp $tmp ../problems/diffs$taskid
                fi
                rm $tmp
              fi
            fi
          else
            words=`wc -w fort.10`
            words=`echo $words | sed -e 's? *\([0-9]*\).*?\1?'`
            lines=`wc -l fort.10`
            lines=`echo $lines | sed -e 's? *\([0-9]*\).*?\1?'`
            nwords=`expr $sixdeskpairs \* 60`
            if test "$words" -ne  $nwords -o "$lines" -ne $sixdeskpairs
            then

#MACRO mymess 0 We have $words words, $lines lines in fort.10 (NOT $nwords, $sixdeskpairs)
              sixdeskmesslevel=0
              sixdeskmess="We have $words words, $lines lines in fort.10 (NOT $nwords, $sixdeskpairs)"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!
              sixdeskmesslevel=0
              sixdeskmess="THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!"
              sixdeskmess
#MACRO mymess

              ignore="true"
              delete="true"
              anerror="true"
            else 
              line1=`head -1 fort.10`
              word1=`echo $line1 | cut -d" " -f1`
              word2=`echo $line1 | cut -d" " -f2`
              word3=`echo $line1 | cut -d" " -f3`
              word4=`echo $line1 | cut -d" " -f4`
              word7=`echo $line1 | cut -d" " -f7`
              word8=`echo $line1 | cut -d" " -f8`
              word9=`echo $line1 | cut -d" " -f9`
              word10=`echo $line1 | cut -d" " -f10`
              word11=`echo $line1 | cut -d" " -f11`
              word22=`echo $line1 | cut -d" " -f22`
              word23=`echo $line1 | cut -d" " -f23`
              word26=`echo $line1 | cut -d" " -f26`
              word27=`echo $line1 | cut -d" " -f27`
              word59=`echo $line1 | cut -d" " -f59`
              word60=`echo $line1 | cut -d" " -f60`
              word52=`echo $line1 | cut -d" " -f52`

#MACRO mymess 0 Maxturn $word1 Lost $word2 Qx/Qy $word3 $word4
              sixdeskmesslevel=0
              sixdeskmess="Maxturn $word1 Lost $word2 Qx/Qy $word3 $word4"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0  1st Ampx/y $word7 $word8 2nd $word26 $word27
              sixdeskmesslevel=0
              sixdeskmess=" 1st Ampx/y $word7 $word8 2nd $word26 $word27"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 DP $word9 Findist $word10 Maxslope $word11 Turns $word22 $word23
              sixdeskmesslevel=0
              sixdeskmess="DP $word9 Findist $word10 Maxslope $word11 Turns $word22 $word23"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 CPU $word60 seconds Version $word52
              sixdeskmesslevel=0
              sixdeskmess="CPU $word60 seconds Version $word52"
              sixdeskmess
#MACRO mymess

              gzip -f fort.10
              ignore="false"
              success="true"
              delete="true"
            fi
          fi
        fi
      fi
      if test $sixdeskplatform != "boinc"
      then
        if test $stat -ne 0 -o ! -s sixres.tar.gz
        then

#MACRO mymess 0 Download of task $taskid FAILED!!! Status $stat Message `cat down` or empty tar file
          sixdeskmesslevel=0
          sixdeskmess="Download of task $taskid FAILED!!! Status $stat Message `cat down` or empty tar file"
          sixdeskmess
#MACRO mymess

          rm down
          # probably a WEB service problem
          # but delete it anyway (if possible)
          delete="true"
          anerror="true"
          ignore="true"
        else 
          cat down
          rm down
          ls -l sixres.tar.gz
          cp sixres.tar.gz w$taskid.tar.gz 
          gunzip -f sixres.tar.gz > mess 2>&1
          stat=$?
          if test $stat -ne 0
          then

#MACRO mymess 0 `ls -l sixres.tar.gz`
            sixdeskmesslevel=0
            sixdeskmess="`ls -l sixres.tar.gz`"
            sixdeskmess
#MACRO mymess


#MACRO mymess 0 gunzip failed!!! `cat mess`
            sixdeskmesslevel=0
            sixdeskmess="gunzip failed!!! `cat mess`"
            sixdeskmess
#MACRO mymess

            # now just delete it but log for future reference
            delete="true"
            anerror="true"
            mkdir -p problems
            mv w$taskid.tar.gz problems
          else
            rm mess
            tar -xf sixres.tar > mess 2>&1
            stat=$?
            if test $stat -ne 0
            then

#MACRO mymess 0 Untar of sixres.tar failed!!!
              sixdeskmesslevel=0
              sixdeskmess="Untar of sixres.tar failed!!!"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 `ls -l sixres.tar`
              sixdeskmesslevel=0
              sixdeskmess="`ls -l sixres.tar`"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 `cat $where/mess`
              sixdeskmesslevel=0
              sixdeskmess="`cat $where/mess`"
              sixdeskmess
#MACRO mymess

              rm mess
              # never seen this in practice, just delete it
              delete="true"
              anerror="true"
              ignore="true"
              mkdir -p problems
              mv w$taskid.tar.gz problems
            elif test ! -d sixtrack
            then

#MACRO mymess 0 Sixtrack untar has not produced a sixtrack directory!!!
              sixdeskmesslevel=0
              sixdeskmess="Sixtrack untar has not produced a sixtrack directory!!!"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 `ls -l sixres.tar`
              sixdeskmesslevel=0
              sixdeskmess="`ls -l sixres.tar`"
              sixdeskmess
#MACRO mymess


#MACRO mymess 0 `cat mess`
              sixdeskmesslevel=0
              sixdeskmess="`cat mess`"
              sixdeskmess
#MACRO mymess
 
              rm mess
              # never seen this in practice, just delete it
              delete="true"
              anerror="true"
              ignore="true"
              mkdir -p problems
              mv w$taskid.tar.gz problems
            else
              rm mess
              rm sixres.tar
              cd sixtrack
              touch sixtrack.exe
              rm sixtrack.exe
              # Now remove any \r characters from Windows in ASCII text files
              for fileno in 4 6 9 10 12 14 15 17 18 19 \
                           20 21 22 23 24 25 26 27 28 29 31 34 91 92 93 98
              do
                myfil=fort.$fileno
                if test -s $myfil
                then
                  file $myfil | egrep "CRLF" > /dev/null 2>&1
                  if test $? -ne 0
                  then
                    awk -f ${SCRIPTDIR}/awk/remover.awk $myfil > $tmp
                    mv $tmp $myfil
                  fi
                fi
              done 
              if test -f fort.93
              then
                echo "$Runnam $Rundir $taskid" >> $sixdesklogdir/restart.log
                cat fort.93 >> $sixdesklogdir/restart.log
              fi
              myRunnam=`echo $Runnam | cut -c1-50`
              head -20 fort.6 | grep "$myRunnam" > headmess 2>&1
              stat=$?

#MACRO mymess 1 `cat headmess`
              sixdeskmesslevel=1
              sixdeskmess="`cat headmess`"
              sixdeskmess
#MACRO mymess

              rm headmess
              if test $stat -ne 0
              then

#MACRO mymess 0 Cannot find Runnam $Runnam in fort.6 !!!; wrong results???
                sixdeskmesslevel=0
                sixdeskmess="Cannot find Runnam $Runnam in fort.6 !!!; wrong results???"
                sixdeskmess
#MACRO mymess

                delete="true"
                ignore="true"
                anerror="true"
                mkdir -p ../problems
                mv ../w$taskid.tar.gz ../problems
              elif test ! -s fort.10
              then

#MACRO mymess 0 Something strange with fort.10!!! `ls -l fort.10`
                sixdeskmesslevel=0
                sixdeskmess="Something strange with fort.10!!! `ls -l fort.10`"
                sixdeskmess
#MACRO mymess

                delete="true"
                ignore="true"
                anerror="true"
                mkdir -p ../problems
                mv ../w$taskid.tar.gz ../problems
              else
                cp fort.10 ../fort.10.w$taskid
                tail -10 fort.6 | grep "Turn(s)" > myturns$$
                stat=$?
                if test $stat -ne 0
                then

#MACRO mymess 0 No Turn(s) reported in fort.6!!! `ls -l fort.6`
                  sixdeskmesslevel=0
                  sixdeskmess="No Turn(s) reported in fort.6!!! `ls -l fort.6`"
                  sixdeskmess
#MACRO mymess


#MACRO mymess 0 `cat myturns$$`
                  sixdeskmesslevel=0
                  sixdeskmess="`cat myturns$$`"
                  sixdeskmess
#MACRO mymess

                  rm myturns$$
                  delete="true"
                  ignore="true"
                  anerror="true"
                  mkdir -p ../problems
                  mv ../w$taskid.tar.gz ../problems
                else

#MACRO mymess 1 `cat myturns$$`
                  sixdeskmesslevel=1
                  sixdeskmess="`cat myturns$$`"
                  sixdeskmess
#MACRO mymess

                  rm myturns$$
                  if test -s ../fort.10.gz
                  then
                    gunzip -f ../fort.10.gz
#                   diff fort.10 ../fort.10 > /dev/null 2>&1

#MACRO mymktmpdir diffs 
                    sixdesktmpdirname=diffs
                    sixdesktmpdirarg=
                    sixdeskmktmpdir
                    diffs=$sixdesktmpdir
#MACRO mymktmp

                    cp ../fort.10 $diffs/fort.20
                    cp fort.10 $diffs/fort.21
                    cd $diffs
                    ${SCRIPTDIR}/fortran/verify10.exe > diffs
                    stat=$?
                    cd ..
                    if test $stat -ne 0 
                    then
                      while read aline
                      do

#MACRO mymess 1 Verify10: $aline
                        sixdeskmesslevel=1
                        sixdeskmess="Verify10: $aline"
                        sixdeskmess
#MACRO mymess

                      done < $diffs/diffs
                      sed -e's/0\.000000000000000E+00/0.0000000000000000e+00/g' -e's/E/e/g' fort.10 > fort.10e
                      diff fort.10e ../fort.10 > /dev/null 2>&1
                      stat=$?
                      rm fort.10e
                      if test $stat -ne 0
                      then

#MACRO mymess 0 exponent e? NO numerical difference !!!
                        sixdeskmesslevel=0
                        sixdeskmess="exponent e? NO numerical difference !!!"
                        sixdeskmess
#MACRO mymess

                      fi
                    fi
                    rm -r $diffs
                    gzip -f ../fort.10
                    if test $stat -ne 0
                    then

#MACRO mymess 1 Results in fort.10 identical to previous run. Ignore and remove
                      sixdeskmesslevel=1
                      sixdeskmess="Results in fort.10 identical to previous run. Ignore and remove"
                      sixdeskmess
#MACRO mymess

                      ignore="true"
                      delete="true"
                      duplicate="true"
  # This line added to ensure that the case is marked completed
  # The results may have been produced by a different workspace
                      success="true"
                      rm ../w$taskid.tar.gz
                      rm ../fort.10.w$taskid
                    else

#MACRO mymess 0 New fort.10 from Task $taskid is different!!!!
                      sixdeskmesslevel=0
                      sixdeskmess="New fort.10 from Task $taskid is different!!!!"
                      sixdeskmess
#MACRO mymess


#MACRO mymess 0 THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!
                      sixdeskmesslevel=0
                      sixdeskmess="THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!"
                      sixdeskmess
#MACRO mymess

                      ignore="true"
                      delete="true"
                      anerror="true"
                      mkdir -p ../problems
                      mv ../w$taskid.tar.gz ../problems
                    fi
                  else
                    words=`wc -w fort.10`
                    words=`echo $words | sed -e 's? *\([0-9]*\).*?\1?'`
                    lines=`wc -l fort.10`
                    lines=`echo $lines | sed -e 's? *\([0-9]*\).*?\1?'`
                    nwords=`expr $sixdeskpairs \* 60`
                    if test "$words" -ne  $nwords -o "$lines" -ne $sixdeskpairs
                    then

#MACRO mymess 0 We have $words words, $lines lines in fort.10 (NOT $nwords, $sixdeskpairs)
                      sixdeskmesslevel=0
                      sixdeskmess="We have $words words, $lines lines in fort.10 (NOT $nwords, $sixdeskpairs)"
                      sixdeskmess
#MACRO mymess


#MACRO mymess 0 THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!
                      sixdeskmesslevel=0
                      sixdeskmess="THIS IS A VERY SERIOUS ERROR!!!!!!!!!!!!"
                      sixdeskmess
#MACRO mymess

                      ignore="true"
                      delete="true"
                      anerror="true"
                      mkdir -p ../problems
                      mv ../w$taskid.tar.gz ../problems
                    else
                      rm ../w$taskid.tar.gz
                      rm ../fort.10.w$taskid
                      gzip -f *
                      ignore="false"
                    fi
                  fi
                fi
                # End of it all (except copying to CASTOR)
              fi
              # End of 1st time or not
              cd $where
              if test "$ignore" = "false"
              then
                #Now figure out the CASTOR name etc
                if test "$sixdeskcastor" = "true"
                then
                  export RFIO_USE_CASTOR_V2="YES"
                  export STAGE_HOST="castorpublic"
                  export STAGE_SVCCLASS="default"
                  CASTOR=/castor/cern.ch/nap/$LOGNAME/direct_track/$Rundir

#MACRO mymess 1 CASTOR of $Runnam.tar to $CASTOR
                  sixdeskmesslevel=1
                  sixdeskmess="CASTOR of $Runnam.tar to $CASTOR"
                  sixdeskmess
#MACRO mymess

                  nsrm -rf $CASTOR > /dev/null 2>&1
                  nsmkdir -p $CASTOR
                fi
                cd sixtrack
                tar cvf ../$Runnam.tar fort.*.gz > $tmp 2>&1
                stat=$?
                cd ..
                if test $stat -ne 0
                then

#MACRO mymess 0 Tar $Runnam.tar $where/sixtrack/fort.*.gz failed!!!
                  sixdeskmesslevel=0
                  sixdeskmess="Tar $Runnam.tar $where/sixtrack/fort.*.gz failed!!!"
                  sixdeskmess
#MACRO mymess


#MACRO mymess 0 `cat $tmp`
                  sixdeskmesslevel=0
                  sixdeskmess="`cat $tmp`"
                  sixdeskmess
#MACRO mymess

                  rm $tmp
                  anerror="true"
                else
                  rm $tmp
                  if test "$sixdeskcastor" = "true"
                  then
                    rfcp $Runnam.tar $CASTOR > $tmp 2>&1
                    stat=$?
                    rm $Runnam.tar
                    if test $stat -ne 0
                    then

#MACRO mymess 0 Copy to CASTOR failed!!! rfcp $where/sixtrack/$Runnam.tar $CASTOR
                      sixdeskmesslevel=0
                      sixdeskmess="Copy to CASTOR failed!!! rfcp $where/sixtrack/$Runnam.tar $CASTOR"
                      sixdeskmess
#MACRO mymess


#MACRO mymess 0 `cat $tmp`
                      sixdeskmesslevel=0
                      sixdeskmess="`cat $tmp`"
                      sixdeskmess
#MACRO mymess

                      rm $tmp
                      anerror="true"
                    else
                      rm $tmp
                      success="true"
                      delete="true"
                    fi
                  else
                    # CASTOR is not available
                    success="true"
                    delete="true"
                  fi
                  # test of castor copy?
                fi
                # end of tar OK?
              fi
              # end of various nasties with fort.10 fort.6 etc
            fi
            # end of untar problem or not
          fi
          # end of gunzip problem
        fi
        # end of download result
      fi
      # end of if NOT BOINC
      touch $where/down
      rm $where/down
    fi
    # end of checking where
  fi
  # end of found a taskid or not
  cd $sixdeskhome
  if test "$success" = "true"
  then

#MACRO mymess 1 Saving fort.10.gz and updating completed jobs etc
    sixdeskmesslevel=1
    sixdeskmess="Saving fort.10.gz and updating completed jobs etc"
    sixdeskmess
#MACRO mymess

    if test "$duplicate" = "false"
    then
      mv $where/sixtrack/fort.10.gz $where/fort.10.gz 
    fi

#MACRO mylock $sixdeskwork
###    sixdesklockdir=$sixdeskwork
###    sixdesklock
#MACRO mylock


# Now we make a file completed_this_run which we will
# use to update a parallel mycompleted_cases and myincomplete_cases
    echo "$Runnam" >> $sixdeskwork/completed_this_run
    touch $sixdeskwork/DEBUG
    sed -e'/^'$Runnam'$/d' $sixdeskwork/incomplete_cases > $tmp
    cp $tmp $sixdeskwork/incomplete_cases
    if test $? -ne 0
    then
      stat $sixdeskwork/incomplete_cases >> $sixdeskwork/DEBUG
      stat $tmp >> $sixdeskwork/DEBUG

#MACRO mymess 0 AFS problem with incomplete cases!!!
      sixdeskmesslevel=0
      sixdeskmess="AFS problem with incomplete cases!!!"
      sixdeskmess
#MACRO mymess


#MACRO mymess 0 `stat $sixdeskwork/incomplete_cases`
      sixdeskmesslevel=0
      sixdeskmess="`stat $sixdeskwork/incomplete_cases`"
      sixdeskmess
#MACRO mymess


#MACRO mymess 0 `stat $tmp`
      sixdeskmesslevel=0
      sixdeskmess="`stat $tmp`"
      sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
      sixdesklockdir=$sixdeskstudy
      sixdeskunlock
#MACRO myunlock


#MACRO myexit 999
      sixdeskexitparam=999
      sixdeskexit
#MACRO myexit

    else
      rm $tmp
    fi
    dicases=`wc -l $sixdeskwork/incomplete_cases`
    dicases=`echo $dicases | sed -e 's? *\([0-9]*\).*?\1?'`
    if test -s $sixdeskwork/completed_cases
    then
      sed -e'/^'$Runnam'$/d' $sixdeskwork/completed_cases > $tmp
      cp $tmp $sixdeskwork/completed_cases
      if test $? -ne 0
      then
        stat $sixdeskwork/completed_cases >> $sixdeskwork/DEBUG
        stat $tmp >> $sixdeskwork/DEBUG

#MACRO mymess 0 AFS problem with completed cases!!!
        sixdeskmesslevel=0
        sixdeskmess="AFS problem with completed cases!!!"
        sixdeskmess
#MACRO mymess


#MACRO mymess 0 `stat $sixdeskwork/completed_cases`
        sixdeskmesslevel=0
        sixdeskmess="`stat $sixdeskwork/completed_cases`"
        sixdeskmess
#MACRO mymess


#MACRO mymess 0 `stat $tmp`
        sixdeskmesslevel=0
        sixdeskmess="`stat $tmp`"
        sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
        sixdesklockdir=$sixdeskstudy
        sixdeskunlock
#MACRO myunlock


#MACRO myexit 999
        sixdeskexitparam=999
        sixdeskexit
#MACRO myexit

      else
        rm $tmp
      fi
    fi
    echo $Runnam >> $sixdeskwork/completed_cases
    dccases=`wc -l $sixdeskwork/completed_cases`
    dccases=`echo $dccases | sed -e 's? *\([0-9]*\).*?\1?'`
    tot=`expr $dicases + $dccases`
    allcases=`wc -l $sixdeskwork/taskids`
    allcases=`echo $allcases | sed -e 's? *\([0-9]*\).*?\1?'`
    if test "$tot" -ne "$allcases"
    then

#MACRO mymess 0 DEBUGZ $tot NOT= $allcases !!!
      sixdeskmesslevel=0
      sixdeskmess="DEBUGZ $tot NOT= $allcases !!!"
      sixdeskmess
#MACRO mymess

      stat $sixdeskwork/completed_cases >> $sixdeskwork/DEBUG
      stat $sixdeskwork/incomplete_cases >> $sixdeskwork/DEBUG

#MACRO mymess 0 `stat $sixdeskwork/completed_cases`
      sixdeskmesslevel=0
      sixdeskmess="`stat $sixdeskwork/completed_cases`"
      sixdeskmess
#MACRO mymess


#MACRO mymess 0 `stat $sixdeskwork/incomplete_cases`
      sixdeskmesslevel=0
      sixdeskmess="`stat $sixdeskwork/incomplete_cases`"
      sixdeskmess
#MACRO mymess


#MACRO myunlock $sixdeskstudy
      ###sixdesklockdir=$sixdeskstudy
      ###sixdeskunlock
#MACRO myunlock

    fi
    #Eric here we should now delete other redundant tasks
    #mess="Taskids were x$taskids""x"
    #taskids=`echo "$taskids" | sed -e's? '$taskid' ? ?'`
    #mess="Taskids now x$taskids""x"
    #for l in $taskids
    #do
    #  echo "Here I will delete $l in $mytgid"
    #done

#MACRO myunlock $sixdeskwork
    ###sixdesklockdir=$sixdeskwork
    ###sixdeskunlock
#MACRO myunlock


#MACRO mymess 2 Removing JOB_NOT_YET_COMPLETED in $where
    sixdeskmesslevel=2
    sixdeskmess="Removing JOB_NOT_YET_COMPLETED in $where"
    sixdeskmess
#MACRO mymess

    rm -f $where/JOB_NOT_YET_COMPLETED
#  Do NOT remove input files when using CPSS , BOINC or GRID???
#  rm $where/fort.2.gz $where/fort.3.gz $where/fort.8.gz $where/fort.16.gz
  fi
  if test "$where" != ""
  then
    if test -d $where
    then
      if test -d $where/sixtrack
      then
        rm -r $where/sixtrack
      fi
      echo "Final state of $where"
      ls -l $where
    fi
  fi
  if test "$delete" = "true"
  then
    # success = true => delete = true
    if test "$unknown" = "false"
    then

#MACRO mylock $sixdeskjobs
      ###sixdesklockdir=$sixdeskjobs
      ###sixdesklock
#MACRO mylock

      touch $sixdeskjobs/incomplete_tasks
      sed -e'/'$Runnam' '$taskid'/d' $sixdeskjobs/incomplete_tasks > $tmp
      mv $tmp $sixdeskjobs/incomplete_tasks
      touch $sixdeskjobs/completed_tasks
      sed -e'/'$Runnam' '$taskid'/d' $sixdeskjobs/completed_tasks > $tmp
      mv $tmp $sixdeskjobs/completed_tasks
      echo "$Runnam" "$taskid" >> $sixdeskjobs/completed_tasks

#MACRO myunlock $sixdeskjobs
      ###sixdesklockdir=$sixdeskjobs
      ###sixdeskunlock
#MACRO myunlock

    fi
    if test $sixdeskplatform = "cpss"
    then

#MACRO mymess 1 Deleting result $ntaskid from the server
      sixdeskmesslevel=1
      sixdeskmess="Deleting result $ntaskid from the server"
      sixdeskmess
#MACRO mymess

      perl ${SCRIPTDIR}/perl/confirmResultDownload.pl $ntaskid > $tmp 2>&1
      stat=$?
      if test $stat -ne 0
      then

#MACRO mymess 0 confirmResultDownload failed!!! `cat $tmp`
        sixdeskmesslevel=0
        sixdeskmess="confirmResultDownload failed!!! `cat $tmp`"
        sixdeskmess
#MACRO mymess

      fi
      rm $tmp
    elif test $sixdeskplatform = "boinc"
    then

#MACRO mymess 1 Deleting result $taskid
      sixdeskmesslevel=1
      sixdeskmess="Deleting result $taskid"
      sixdeskmess
#MACRO mymess

      if test "$Runnam" != ""
      then
        rm -f $sixdeskboincdir/results/${workspace}_${boincRunnam}_1_sixvf_$taskid
         # and try and remove Alex .done and .zip

#MACRO mymess 1 Deleting .done and .zip
         sixdeskmesslevel=1
         sixdeskmess="Deleting .done and .zip"
         sixdeskmess
#MACRO mymess

         rm -f $sixdeskboincdir/work/${workspace}_${boincRunnam}_1_sixvf_$taskid.desc.done
         rm -f $sixdeskboincdir/work/${workspace}_${boincRunnam}_1_sixvf_$taskid.zip
      else
        rm -f $sixdeskboincdir/results/${workspace}_*_1_sixvf_$taskid
        # Alex stuff?
        rm -f $sixdeskboincdir/work/${workspace}_*_1_sixvf_$taskid.desc.done
        rm -f $sixdeskboincdir/work/${workspace}_*_1_sixvf_$taskid.zip
      fi
    fi
  fi
  if test $success = "false"
  then
    if test "$anerror" = "true"
    then

#MACRO mymess 0 Download FAILED for $taskid : $where  !!!
      sixdeskmesslevel=0
      sixdeskmess="Download FAILED for $taskid : $where  !!!"
      sixdeskmess
#MACRO mymess

      failed=`expr $failed + 1`
      touch $sixdesklogdir/sixdeskerror.log
      grep "^$taskid " $sixdesklogdir/sixdeskerror.log > /dev/null 2>&1
      if test $? -ne 0
      then
        echo "$taskid $Runnam $Rundir" >> $sixdesklogdir/sixdeskerror.log
      fi
    fi
  fi
  if test "$duplicate" = "true" 
  then
    duplicated=`expr $duplicated + 1`

#MACRO mymess 1 $taskid ignored (duplicate/redundant result)
    sixdeskmesslevel=1
    sixdeskmess="$taskid ignored (duplicate/redundant result)"
    sixdeskmess
#MACRO mymess

  elif test "$success" = "true"
  then
    ok=`expr $ok + 1`

#MACRO mymess 1 $taskid downloaded successfully to $where
    sixdeskmesslevel=1
    sixdeskmess="$taskid downloaded successfully to $where"
    sixdeskmess
#MACRO mymess

  fi
#Eric
done  
# end of all tasks
rm -f $sixdesktasklist

#MACRO mymess 0 Before this download $cases cases, $ccases complete ($icases incomplete)
sixdeskmesslevel=0
sixdeskmess="Before this download $cases cases, $ccases complete ($icases incomplete)"
sixdeskmess
#MACRO mymess

if test "$ready" -ne 0
then

#MACRO mymess 0 Of $ready Ready results, $ok were downloaded successfully, $duplicated were deleted as duplicate/redundant, and $failed failed.
  sixdeskmesslevel=0
  sixdeskmess="Of $ready Ready results, $ok were downloaded successfully, $duplicated were deleted as duplicate/redundant, and $failed failed."
  sixdeskmess
#MACRO mymess

else

#MACRO mymess 0 There were no results available
  sixdeskmesslevel=0
  sixdeskmess="There were no results available"
  sixdeskmess
#MACRO mymess

fi

#MACRO myunlock $sixdeskstudy
###sixdesklockdir=$sixdeskstudy
###sixdeskunlock
#MACRO myunlock


# Get the counts after the run for checking

#MACRO mylock $sixdeskwork
###sixdesklockdir=$sixdeskwork
###sixdesklock
#MACRO mylock

if test -f $sixdeskwork/taskids
then
  cases=`wc -l "$sixdeskwork/taskids"`
  cases=`echo "$cases" | sed -e 's? *\([0-9]*\).*?\1?'`
fi
icases=0
if test -s $sixdeskwork/incomplete_cases
then
  icases=`wc -l $sixdeskwork/incomplete_cases`
  icases=`echo $icases | sed -e 's? *\([0-9]*\).*?\1?'`
fi
ccases=0
if test -s $sixdeskwork/completed_cases
then
  ccases=`wc -l $sixdeskwork/completed_cases`
  ccases=`echo $ccases | sed -e 's? *\([0-9]*\).*?\1?'`
fi

#MACRO mymess 0 After  this download $cases cases, $ccases complete ($icases incomplete)
sixdeskmesslevel=0
sixdeskmess="After  this download $cases cases, $ccases complete ($icases incomplete)"
sixdeskmess
#MACRO mymess

update_cases
rm -f $tmp

#MACRO myunlock $sixdeskwork
###sixdesklockdir=$sixdeskwork
###sixdeskunlock
#MACRO myunlock


#MACRO myunlock $sixdeskstudy
sixdesklockdir=$sixdeskstudy
sixdeskunlock
#MACRO myunlock


#MACRO myexit 0
sixdeskexitparam=0
sixdeskexit
#MACRO myexit

